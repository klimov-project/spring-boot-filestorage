<!DOCTYPE html>
<html>

    <head>
        <title>Тест авторизации и сессий</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>KlimovRV | FileStorage</title>
        <meta name="description" content="KlimovRV FileStorage" />
        <meta name="keywords" content="File, Storage" />
        <meta name="author" content="KlimovRV" />
        <link rel="icon shortcut" href="favicon.a64e97b2.ico" />
        <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon.65416d1f.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.2043f2db.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.bc68d9cd.png" />
        <link rel="stylesheet" href="style.css" />
    </head>

    <body>
        <h1>Тест авторизации и сессий</h1>

        <div class="box info" id="session-info">
            <h3>Текущая сессия:</h3>
            <p><strong>Статус:</strong> Не проверено</p>
            <button onclick="checkSession()">Проверить сессию</button>
        </div>

        <div class="box">
            <h3>Регистрация (API):</h3>
            <input type="text" id="reg-username" placeholder="Имя пользователя" required />
            <input type="password" id="reg-password" placeholder="Пароль" required />
            <button onclick="signup()">Зарегистрироваться</button>
            <div id="reg-result"></div>
        </div>

        <div class="box">
            <h3>Вход (API):</h3>
            <input type="text" id="login-username" placeholder="Имя пользователя" required />
            <input type="password" id="login-password" placeholder="Пароль" required />
            <button onclick="signin()">Войти</button>
            <div id="login-result"></div>
        </div>

        <div class="box">
            <h3>Выход (API):</h3>
            <button onclick="signout()">Выйти из сессии</button>
            <div id="logout-result"></div>
        </div>

        <div class="box">
            <h3>Проверка Redis сессий:</h3>
            <button onclick="checkRedisSessions()">Показать сессии в Redis</button>
            <pre id="redis-sessions"></pre>
        </div>

        <div class="box">
            <h3>Тесты curl для API:</h3>
            <pre>
# Регистрация
curl -X POST http://localhost:8080/api/auth/sign-up \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"password123"}' \
  -c cookies.txt

# Вход
curl -X POST http://localhost:8080/api/auth/sign-in \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"password123"}' \
  -c cookies.txt

# Проверка сессии (с куками)
curl -X GET http://localhost:8080/api/user/me \
  -b cookies.txt

# Выход
curl -X POST http://localhost:8080/api/auth/sign-out \
  -b cookies.txt

# Проверка сессий в Redis
docker exec my_redis redis-cli KEYS "spring:session:*"
        </pre>
        </div>

        <script>
            // Функция для проверки текущей сессии
            async function checkSession() {
                try {
                    const response = await fetch('/api/user/me', {
                        credentials: 'include', // Важно! Отправляем куки
                    });

                    const sessionInfo = document.getElementById('session-info');
                    if (response.status === 200) {
                        const user = await response.json();
                        sessionInfo.innerHTML = `
                        <h3>Текущая сессия:</h3>
                        <p><strong>Пользователь:</strong> ${user.username}</p>
                        <p><strong>Статус:</strong> ✅ Аутентифицирован</p>
                        <p><strong>Время:</strong> ${new Date().toLocaleTimeString()}</p>
                    `;
                        sessionInfo.className = 'box success';
                    } else {
                        sessionInfo.innerHTML = `
                        <h3>Текущая сессия:</h3>
                        <p><strong>Статус:</strong> ❌ Не аутентифицирован</p>
                        <p><strong>Время:</strong> ${new Date().toLocaleTimeString()}</p>
                    `;
                        sessionInfo.className = 'box error';
                    }
                } catch (error) {
                    console.error('Ошибка при проверке сессии:', error);
                }
            }

            // Регистрация
            async function signup() {
                const username = document.getElementById('reg-username').value;
                const password = document.getElementById('reg-password').value;
                console.log("username, password");
                console.log(username, password);
                try {
                    const response = await fetch('http://localhost:8080/api/auth/sign-up', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include',
                    });

                    const resultDiv = document.getElementById('reg-result');
                    if (response.status === 201) {
                        resultDiv.innerHTML = '✅ Регистрация успешна!';
                        resultDiv.className = 'success';
                        checkSession(); // Проверяем сессию
                    } else {
                        const error = await response.json();
                        resultDiv.innerHTML = `❌ Ошибка: ${error.message}`;
                        resultDiv.className = 'error';
                    }
                } catch (error) {
                    document.getElementById('reg-result').innerHTML = '❌ Ошибка сети';
                }
            }

            // Вход
            async function signin() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch('http://localhost:8080/api/auth/sign-in', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                        credentials: 'include',
                    });

                    const resultDiv = document.getElementById('login-result');
                    if (response.status === 200) {
                        resultDiv.innerHTML = '✅ Вход успешен!';
                        resultDiv.className = 'success';
                        checkSession(); // Проверяем сессию
                    } else {
                        const error = await response.json();
                        resultDiv.innerHTML = `❌ Ошибка: ${error.message}`;
                        resultDiv.className = 'error';
                    }
                } catch (error) {
                    document.getElementById('login-result').innerHTML = '❌ Ошибка сети';
                }
            }

            // Выход
            async function signout() {
                try {
                    const response = await fetch('http://localhost:8080/api/auth/sign-out', {
                        method: 'POST',
                        credentials: 'include',
                    });

                    const resultDiv = document.getElementById('logout-result');
                    if (response.status === 204) {
                        resultDiv.innerHTML = '✅ Выход успешен!';
                        resultDiv.className = 'success';
                        checkSession(); // Проверяем сессию
                    } else {
                        resultDiv.innerHTML = '❌ Ошибка при выходе';
                        resultDiv.className = 'error';
                    }
                } catch (error) {
                    document.getElementById('logout-result').innerHTML = '❌ Ошибка сети';
                }
            }

            // Проверка сессий в Redis (через наш API)
            async function checkRedisSessions() {
                try {
                    const response = await fetch('http://localhost:8080/api/admin/redis-sessions', {
                        credentials: 'include',
                    });
                    const data = await response.json();
                    document.getElementById(
                        'redis-sessions',
                    ).textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error('Ошибка:', error);
                }
            }

            // Проверяем сессию при загрузке страницы
            checkSession();
        </script>
    </body>

</html>